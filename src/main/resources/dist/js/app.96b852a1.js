(function(e){function t(t){for(var a,s,c=t[0],r=t[1],l=t[2],u=0,p=[];u<c.length;u++)s=c[u],o[s]&&p.push(o[s][0]),o[s]=0;for(a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);d&&d(t);while(p.length)p.shift()();return i.push.apply(i,l||[]),n()}function n(){for(var e,t=0;t<i.length;t++){for(var n=i[t],a=!0,c=1;c<n.length;c++){var r=n[c];0!==o[r]&&(a=!1)}a&&(i.splice(t--,1),e=s(s.s=n[0]))}return e}var a={},o={1:0},i=[];function s(t){if(a[t])return a[t].exports;var n=a[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=a,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)s.d(n,a,function(t){return e[t]}.bind(null,a));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/";var c=window["webpackJsonp"]=window["webpackJsonp"]||[],r=c.push.bind(c);c.push=t,c=c.slice();for(var l=0;l<c.length;l++)t(c[l]);var d=r;i.push([4,0]),n()})({"0DAh":function(e,t,n){"use strict";var a=n("CGE3"),o=n.n(a);o.a},4:function(e,t,n){e.exports=n("Vtdi")},"6aD1":function(e,t,n){},CGE3:function(e,t,n){},EDI0:function(e,t,n){},Ijvu:function(e,t,n){"use strict";var a=n("6aD1"),o=n.n(a);o.a},Vtdi:function(e,t,n){"use strict";n.r(t);n("VRzm");var a=n("Kw5r"),o=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{attrs:{id:"app"}},[n("DevicesList")],1)},i=[],s=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("div",{staticClass:"header"},[n("span",{staticClass:"header_font"},[n("Icon",{attrs:{type:"navicon-round"}}),e._v(" 设备列表")],1)]),n("div",{staticClass:"content"},[n("Row",[n("Col",{attrs:{span:"8"}},[n("span",{staticClass:"searchFont"},[e._v("设备编号：")]),n("Input",{staticStyle:{width:"300px"},model:{value:e.searchData.code,callback:function(t){e.$set(e.searchData,"code",t)},expression:"searchData.code"}})],1),n("Col",{attrs:{span:"8"}},[n("span",{staticClass:"searchFont"},[e._v("设备状态：")]),n("RadioGroup",{model:{value:e.searchData.online,callback:function(t){e.$set(e.searchData,"online",t)},expression:"searchData.online"}},[n("Radio",{attrs:{label:"a"}},[e._v("不限")]),n("Radio",{attrs:{label:"y"}},[e._v("在线")]),n("Radio",{attrs:{label:"n"}},[e._v("离线")])],1)],1),n("Col",{attrs:{span:"8"}},[n("Button",{attrs:{type:"primary",icon:"android-search"},on:{click:e.loadDevicesList}},[e._v("查询")]),n("Button",{staticStyle:{"margin-left":"20px"},attrs:{type:"ghost",icon:"android-refresh"},on:{click:e.resetSearch}},[e._v("重置")])],1)],1),n("Row",{staticStyle:{"margin-top":"20px"}},[n("Col",{attrs:{span:"24"}},[n("Button",{attrs:{type:"primary",icon:"plus-round"},on:{click:e.addDeviceBtnClick}},[e._v("添加设备")])],1)],1),n("Row",{staticClass:"tableHeader"},[n("Col",{attrs:{span:"3"}},[n("span",{staticClass:"searchFont"},[e._v("安装时间")])]),n("Col",{attrs:{span:"3"}},[n("span",{staticClass:"searchFont"},[e._v("设备编号")])]),n("Col",{attrs:{span:"9"}},[n("span",{staticClass:"searchFont"},[e._v("安装地址")])]),n("Col",{attrs:{span:"3"}},[n("span",{staticClass:"searchFont"},[e._v("设备状态")])]),n("Col",{attrs:{span:"6"}},[n("span",{staticClass:"searchFont"},[e._v("操作")])])],1),e._l(e.devicesList,function(t){return n("Row",{key:t.id,staticClass:"tableContent"},[n("Col",{attrs:{span:"3"}},[e._v("\n                "+e._s(t.install_time)+"\n            ")]),n("Col",{attrs:{span:"3"}},[e._v("\n                "+e._s(t.code)+"\n            ")]),n("Col",{attrs:{span:"9"}},[e._v("\n                "+e._s(t.install_address)+"\n            ")]),n("Col",{attrs:{span:"3"}},["y"===t.online?n("span",{staticStyle:{color:"#52c41a"}},[e._v("在线")]):e._e(),"n"===t.online?n("span",{staticStyle:{color:"red"}},[e._v("离线")]):e._e()]),n("Col",{attrs:{span:"6"}},[n("CallDevice",{attrs:{deviceCode:t.code,online:t.online},on:{reloadDeviceList:e.loadDevicesList}})],1)],1)}),n("Row",{staticStyle:{"margin-top":"20px","text-align":"center"}},[n("Col",{attrs:{span:"24"}},[n("Page",{attrs:{total:e.total,current:e.searchData.page,size:"small","show-elevator":"","show-sizer":"","show-total":""},on:{"on-change":e.pageChange,"on-page-size-change":e.pageSizeChange}})],1)],1),n("Modal",{attrs:{title:"添加设备"},model:{value:e.showDeviceForm,callback:function(t){e.showDeviceForm=t},expression:"showDeviceForm"}},[n("Form",{ref:"addDeviceFormRef",attrs:{model:e.deviceForm,"label-width":80,rules:e.deviceFormValidateRules}},[n("FormItem",{attrs:{label:"安装日期"}},[n("DatePicker",{attrs:{type:"date",format:"yyyy-MM-dd",placeholder:"不选择则默认为当前日期"},model:{value:e.deviceForm.install_time,callback:function(t){e.$set(e.deviceForm,"install_time",t)},expression:"deviceForm.install_time"}})],1),n("FormItem",{attrs:{label:"设备编号",prop:"code"}},[n("Input",{model:{value:e.deviceForm.code,callback:function(t){e.$set(e.deviceForm,"code",t)},expression:"deviceForm.code"}})],1),n("FormItem",{attrs:{label:"安装地址",prop:"install_address"}},[n("Input",{attrs:{type:"textarea",autosize:{minRows:2,maxRows:5}},model:{value:e.deviceForm.install_address,callback:function(t){e.$set(e.deviceForm,"install_address",t)},expression:"deviceForm.install_address"}})],1),n("FormItem",{attrs:{label:"备注"}},[n("Input",{attrs:{type:"textarea",autosize:{minRows:2,maxRows:5}},model:{value:e.deviceForm.description,callback:function(t){e.$set(e.deviceForm,"description",t)},expression:"deviceForm.description"}})],1)],1),n("div",{attrs:{slot:"footer"},slot:"footer"},[n("Button",{attrs:{type:"success",size:"large"},on:{click:e.addDeviceSubmit}},[e._v("添加")])],1)],1)],2)])},c=[],r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",["y"!==e.online||e.showCallView?e._e():n("Button",{attrs:{type:"success",size:"small",icon:"android-microphone"},on:{click:e.callBtnClick}},[e._v("呼叫")]),"y"===e.online&&e.showCallView?n("div",[n("p",[n("audio",{ref:"remoteAudio",attrs:{autoplay:"",controls:""}})]),n("p",[n("Button",{attrs:{type:"error",size:"small",icon:"android-microphone-off"},on:{click:e.closeCallBtnClick}},[e._v("断开")])],1)]):e._e(),"n"===e.online?n("Button",{attrs:{type:"success",size:"small",icon:"android-microphone-off",disabled:""}},[e._v("呼叫")]):e._e()],1)},l=[],d=(n("rGqo"),n("yt8O"),n("9AAn"),n("xmWZ")),u=n("qpph"),p=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(e){},a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){},o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(e){};Object(d["a"])(this,e),this.config=t,this.onLocalStream=n,this.onRemoteStream=a,this.onConnectionStateChange=o,this.peer=null,this.websocket=null}return Object(u["a"])(e,[{key:"createCaller",value:function(e){var t=this;this.connect(e,function(){t.createOffer()})}},{key:"createWaiter",value:function(e){this.connect(e,function(){})}},{key:"close",value:function(){this.peer.close()}},{key:"connect",value:function(e,t){var n=this;this.websocket=new WebSocket("ws://".concat(this.config.signalingServerAddress).concat(e,"?pc")),this.websocket.onopen=function(){console.log("信令服务器连接成功"),n.initLocalMediaStream(t)},this.websocket.onmessage=function(e){var t=JSON.parse(e.data);n.receiveSignaling(t)},this.websocket.onclose=function(e){console.log("信令服务器连接关闭")},this.websocket.onerror=function(e){console.log("信令服务器连接异常",e)}}},{key:"initLocalMediaStream",value:function(e){var t=this;navigator.mediaDevices.getUserMedia(this.config.mediaStreamConstrains).then(function(n){console.log("本地媒体流获取成功"),t.onLocalStream(n),t.initPeerConnection(n),e()}).catch(function(e){console.log("本地媒体流获取失败: ",e)})}},{key:"initPeerConnection",value:function(e){var t=this;this.peer=new RTCPeerConnection(this.config.iceServersConfig),this.peer.onicecandidate=function(e){if(e.candidate){var n={type:"candidate",id:e.candidate.sdpMid,mlineindex:e.candidate.sdpMLineIndex,candidate:e.candidate.candidate};t.websocket.send(JSON.stringify(n))}},this.peer.onaddstream=function(e){t.onRemoteStream(e.stream)},this.peer.oniceconnectionstatechange=function(e){var n=e.originalTarget.iceConnectionState;"disconnected"!==n&&"closed"!==n||t.websocket.close(),t.onConnectionStateChange(n)},this.peer.addStream(e)}},{key:"receiveSignaling",value:function(e){if(this.peer)switch(e.type){case"offer":console.log("接收到offer提议信令"),this.peer.setRemoteDescription(e),this.peer.createAnswer();break;case"answer":console.log("接收到answer应答信令"),this.peer.setRemoteDescription(e);break;case"candidate":console.log("接收到candidate信令"),this.addIceCandidate(e);break;default:break}}},{key:"createOffer",value:function(){var e=this;this.peer.createOffer().then(function(t){console.log("offer提议信令创建成功"),e.setLocalDescription(t)}).catch(function(e){console.log("offer提议信令创建失败",e)})}},{key:"createAnswer",value:function(){var e=this;this.peer.createAnswer().then(function(t){console.log("answer应答信令创建成功"),e.setLocalDescription(t)}).catch(function(e){console.log("answer应答信令创建失败",e)})}},{key:"setLocalDescription",value:function(e){var t=this;this.peer.setLocalDescription(e).then(function(){console.log("LocalDescription 设置成功"),t.websocket.send(JSON.stringify(e)),console.log("信令发送成功，type="+e.type)}).catch(function(e){console.log("LocalDescription 设置失败",e)})}},{key:"setRemoteDescription",value:function(e){this.peer.setRemoteDescription(new RTCSessionDescription(e)).then(function(){console.log("RemoteDescription 设置成功")}).catch(function(e){console.log("RemoteDescription 设置失败",e)})}},{key:"addIceCandidate",value:function(e){this.peer.addIceCandidate(new RTCIceCandidate({sdpMid:e.id,sdpMLineIndex:e.mlineindex,candidate:e.candidate})).then(function(){console.log("iceCandidate 设置成功")}).catch(function(e){console.log("iceCandidate 设置失败",e)})}}]),e}(),f=p,h={mediaStreamConstrains:{audio:!0},signalingServerAddress:"60.2.127.254:9238",iceServersConfig:{iceServers:[{urls:"stun:60.2.127.254:3478"},{urls:"turn:60.2.127.254:3478",username:"inesadt",credential:"inesadt"}]}},v="",m={name:"CallDevice",data:function(){return{showCallView:!1,peerMap:new Map}},props:{deviceCode:{type:String},online:{type:String}},computed:{},created:function(){},watch:{},methods:{callBtnClick:function(){var e,t=this,n=t.deviceCode;t.showCallView=!0;var a=h,o=function(e){},i=function(e){t.$refs["remoteAudio"].srcObject=e},s=function(a){"disconnected"!==a&&"closed"!==a||(t.closeCallBtnClick(),t.$emit("reloadDeviceList")),"connected"===a&&t.peerMap.set(n,e)};e=new f(a,o,i,s),e.createCaller(n)},closeCallBtnClick:function(){var e=this,t=e.deviceCode;e.peerMap.has(t)&&(e.peerMap.get(t).close(),e.peerMap.delete(t)),e.showCallView=!1}},mounted:function(){},components:{}},g=m,C=(n("0DAh"),n("KHd+")),w=Object(C["a"])(g,r,l,!1,null,"4f9f506a",null),y=w.exports,D={name:"DevicesList",data:function(){return{searchData:{code:null,online:"a",page:1,pageSize:10},showDeviceForm:!1,deviceForm:{code:null,install_address:null,install_time:null,description:null},total:0,devicesList:[],deviceFormValidateRules:{code:[{required:!0,message:"请输入设备编号",trigger:"blur"}],install_address:[{required:!0,message:"请输入安装地址",trigger:"blur"}]}}},props:{},computed:{},created:function(){},watch:{},methods:{loadDevicesList:function(){var e=this;e.$axios.get("/devices",{params:e.searchData}).then(function(t){t.data.success&&(e.devicesList=t.data.data.rows,e.total=t.data.data.total)}).catch(function(e){console.log(e)})},pageSizeChange:function(e){this.searchData.pageSize=e,this.loadDevicesList()},pageChange:function(e){this.searchData.page=e,this.loadDevicesList()},resetSearch:function(){this.searchData.code=null,this.searchData.online="a",this.searchData.page=1,this.searchData.pageSize=10,this.loadDevicesList()},addDeviceBtnClick:function(){this.deviceForm.code=null,this.deviceForm.install_address=null,this.deviceForm.install_time=null,this.deviceForm.description=null,this.showDeviceForm=!0},addDeviceSubmit:function(){var e=this,t=this;t.$refs["addDeviceFormRef"].validate(function(n){if(n){var a=t.deviceForm.install_time;a||(a=new Date);var o=a.getMonth()+1<10?"0"+(a.getMonth()+1):a.getMonth()+1;t.deviceForm.install_time="".concat(a.getFullYear(),"-").concat(o,"-").concat(a.getDate()),t.$axios.post("/device",t.deviceForm).then(function(n){n.data.success?(t.showDeviceForm=!1,t.loadDevicesList(),e.$Message.success(n.data.message)):e.$Message.error(n.data.message)}).catch(function(t){e.$Message.error("添加失败",t)})}})}},mounted:function(){this.loadDevicesList()},components:{CallDevice:y}},_=D,b=(n("Ijvu"),Object(C["a"])(_,s,c,!1,null,"7c76e0fa",null)),k=b.exports,S={name:"app",components:{DevicesList:k}},F=S,x=(n("ZL7j"),Object(C["a"])(F,o,i,!1,null,null,null)),L=x.exports,R=n("vDqi"),M=n.n(R),O=n("Qyje"),j=n.n(O),I=n("4GmL"),$=n.n(I);n("3K29");a["default"].config.productionTip=!1,a["default"].use($.a),a["default"].prototype.$axios=M.a,M.a.defaults.baseURL=v,M.a.defaults.transformRequest=[function(e){return j.a.stringify(e)}],M.a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",M.a.defaults.withCredentials=!0,new a["default"]({render:function(e){return e(L)}}).$mount("#app")},ZL7j:function(e,t,n){"use strict";var a=n("EDI0"),o=n.n(a);o.a}});
//# sourceMappingURL=app.96b852a1.js.map